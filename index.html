<title>TwitchCycle</title><style>:root{--bg:#071124;--muted:#9ca3af;--accent:#7dd3fc}html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}body{display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(180deg,var(--bg),#071122);color:#e6eef8}a:focus{outline:none}.app{display:flex;flex-direction:column;height:100vh}main{flex:1;display:block;padding:0;margin:0;height:100%;position:relative}.sidebar{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(180deg,#00000073,#00000059);display:flex;flex-direction:row;align-items:center;justify-content:center;gap:24px;padding:8px 16px;box-shadow:0 2px 8px #0006;z-index:1500;opacity:0;transition:opacity .3s ease}.sidebar:hover{opacity:1}.side-btn{width:40px;height:40px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#00000059;color:var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}.side-btn svg{width:20px;height:20px;display:block}.side-btn:focus{outline:2px solid rgba(125,211,252,.25)}.countdown{font-size:12px;color:var(--muted);width:140px;text-align:center}.player-wrap{position:relative;width:100%;height:100vh;max-width:none}#playerContainer{background:#ffffff03;border-radius:0;overflow:hidden;height:100%}.dialog-backdrop{position:fixed;inset:0;background:#00000073;display:none;align-items:center;justify-content:center;z-index:4000}.dialog{background:#071226;border-radius:8px;padding:16px;min-width:360px;max-width:760px;color:inherit;border:1px solid rgba(255,255,255,.03)}.dialog h3{margin:0 0 8px}.field{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;margin:10px 0}.field label{margin:0;color:var(--muted)}.field input[type=text]{width:120px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit;text-align:left}.field input[type=checkbox]{width:18px;height:18px}.dialog .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}.channels-section{margin-top:12px;border-top:1px solid rgba(255,255,255,.02);padding-top:12px}.channels-list{list-style:none;margin:0;padding:0;max-height:240px;overflow:auto;border-radius:6px;border:1px solid rgba(255,255,255,.02);background:#ffffff03}.channels-list li{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.02);cursor:grab}.channels-list li.dragging{opacity:.5}.channels-list li .name{flex:1;color:inherit}.channels-list li .actions{display:flex;gap:8px;margin-left:8px}.channels-list li button{background:transparent;border:0;color:var(--muted);cursor:pointer}.channels-add{display:flex;gap:8px;margin-top:8px}.channels-add input{flex:1;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit}.btn{padding:8px 10px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit;cursor:pointer}.btn.primary{background:var(--accent);color:#042029;border:none}iframe{display:block;border:0;width:100%;height:100%}</style><body><div class="app"><aside class="sidebar" id="controlsBar" aria-label="Controls"><button id="playPauseBtn" class="side-btn" aria-pressed="false" title="Pause rotation" aria-label="Play pause"></button> <button id="settingsBtn" class="side-btn" aria-label="Settings"></button><div id="countdown" class="countdown" aria-live="polite"></div></aside><main><div class="player-wrap" id="playerWrap"><div id="playerContainer"><div style="padding:18px;color:var(--muted);font-size:13px">Loading player...</div></div></div></main></div><div id="dialogBackdrop" class="dialog-backdrop" aria-hidden="true"><div class="dialog" role="dialog" aria-modal="true"><h3>Settings</h3><div class="field"><label for="autoRotate">Auto rotate</label><input id="autoRotate" type="checkbox"/></div><div class="field"><label for="autoRotateDuration">Auto rotate duration (seconds)</label><input id="autoRotateDuration" type="number" inputmode="numeric" pattern="[0-9]*"/></div><div class="field"><label for="layoutSelect">Layout</label><select id="layoutSelect"><option value="fullscreen">Fullscreen</option><option value="2x2">2x2</option><option value="4x3">4x3</option></select></div><div class="field"><label for="shuffleToggle" title="When checked, select streams randomly and prefer ones not currently shown">Shuffle</label><input type="checkbox" id="shuffleToggle"/></div><div class="channels-section"><h4 style="margin:0 0 8px 0;color:var(--muted)">Channels</h4><ul id="channelsList" class="channels-list" role="list"></ul><div class="channels-add"><input id="addChannelInput" placeholder="Add channel (name)" aria-label="Add channel"/><button id="addChannelBtn" class="btn">Add</button></div></div><div class="actions"><button id="cancelBtn" class="btn">Cancel</button><button id="saveBtn" class="btn primary">Save</button></div></div></div><script>const DEFAULT_USERS=["AdamRoguezy","ADarkLegacy","aksually","ARCHIT3CT","ashleyroboto","banthony","blizz","BobbyBurm","butteryflaky","bwick","Carla","cheebs","chiblee","chrismelberger","ChrispyGameplay","Crub","detune","dudlik","EthanNestor","hankstergirl","hanner","JessCapricorn","johnchoi","LeoSypniewski","Loganolio","Michael_Lopriore","nandre","PapaHogsPalaceOfPleasure","PointCrow","prezoh","sandy","Shaggedy","Skootish","vaqrgaming","vixella","whisqey"].map(t=>t.trim()).filter(Boolean);let users=loadUsers();function loadUsers(){try{const t=localStorage.getItem("tc.users.v1");if(!t)return DEFAULT_USERS.slice();const n=JSON.parse(t);return Array.isArray(n)&&n.length?n.map(l=>String(l).trim()).filter(Boolean):DEFAULT_USERS.slice()}catch{return DEFAULT_USERS.slice()}}function saveUsers(){try{localStorage.setItem("tc.users.v1",JSON.stringify(users))}catch{}}const playerContainer=document.getElementById("playerContainer");let currentIndex=0,rotateTimer=null,nextRotateAt=null,remainingMs=null,runtimePaused=!1,countdownInterval=null,displayedUsers=[];const SETTINGS_KEY="tc.settings.v1",DEFAULT_SETTINGS={autoRotate:!0,durationSec:60,layout:"fullscreen",shuffle:!0};let settings=loadSettings();runtimePaused=!settings.autoRotate;function loadSettings(){try{const t=JSON.parse(localStorage.getItem(SETTINGS_KEY));return Object.assign({},DEFAULT_SETTINGS,t||{})}catch{return Object.assign({},DEFAULT_SETTINGS)}}function saveSettings(){localStorage.setItem(SETTINGS_KEY,JSON.stringify(settings))}function clamp(t,n,l){return Math.max(n,Math.min(l,t))}function parentForEmbed(){return location.hostname||"localhost"}const trashSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false" style="width:16px;height:16px;display:inline-block"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-9l-1 1H5v2h14V4z"/></svg>';function renderChannelsList(){const t=document.getElementById("channelsList");t&&(t.innerHTML="",users.forEach((n,l)=>{const e=document.createElement("li");e.setAttribute("draggable","true"),e.dataset.index=String(l);const s=document.createElement("div");s.className="name",s.textContent=n;const i=document.createElement("div");i.className="actions";const a=document.createElement("button");a.type="button",a.title="Delete channel",a.innerHTML=trashSvg,a.addEventListener("click",r=>{r.stopPropagation(),confirm(`Delete channel "${n}"?`)&&(users.splice(l,1),saveUsers(),renderChannelsList())}),i.appendChild(a),e.appendChild(s),e.appendChild(i),e.addEventListener("dragstart",r=>{e.classList.add("dragging"),r.dataTransfer.setData("text/plain",String(l)),r.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",()=>{e.classList.remove("dragging")}),e.addEventListener("dragover",r=>{r.preventDefault(),r.dataTransfer.dropEffect="move";const d=r.currentTarget}),e.addEventListener("drop",r=>{r.preventDefault();const d=Number(r.dataTransfer.getData("text/plain")),f=Number(e.dataset.index);if(Number.isNaN(d)||Number.isNaN(f)||d===f)return;const o=users.splice(d,1)[0];users.splice(f,0,o),saveUsers(),renderChannelsList()}),t.appendChild(e)}))}function setupChannelsAdd(){const t=document.getElementById("addChannelInput"),n=document.getElementById("addChannelBtn");!t||!n||(n.addEventListener("click",()=>{const l=String(t.value||"").trim();if(!l)return;const e=l.replace(/^@/,"");users.push(e),saveUsers(),renderChannelsList(),t.value=""}),t.addEventListener("keydown",l=>{l.key==="Enter"&&n.click()}))}function mountPlayers(t){playerContainer.innerHTML="",playerContainer.style.display="",playerContainer.style.gridTemplateColumns="",playerContainer.style.gridAutoRows="",playerContainer.style.gap="";const n=t.length;if(n<=1){const e=document.createElement("iframe");e.id="twitch-player-0",e.allow="autoplay; fullscreen",e.src=`https://player.twitch.tv/?channel=${encodeURIComponent(t[0])}&parent=${encodeURIComponent(parentForEmbed())}&muted=true&autoplay=true`,playerContainer.style.display="",playerContainer.appendChild(e);return}let l=2;n===4?l=2:n===12?l=4:l=Math.ceil(Math.sqrt(n)),playerContainer.style.display="grid",playerContainer.style.gridTemplateColumns=`repeat(${l}, 1fr)`,playerContainer.style.gridAutoRows="1fr",playerContainer.style.gap="4px";for(let e=0;e<t.length;e++){const s=t[e],i=document.createElement("div");i.style.position="relative",i.style.width="100%",i.style.paddingTop="56.25%",i.style.overflow="hidden";const a=document.createElement("iframe");a.id=`twitch-player-${e}`,a.allow="autoplay; fullscreen",a.src=`https://player.twitch.tv/?channel=${encodeURIComponent(s)}&parent=${encodeURIComponent(parentForEmbed())}&muted=true&autoplay=true`,a.style.width="100%",a.style.height="100%",a.style.display="block",a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.border="0",i.appendChild(a),playerContainer.appendChild(i)}}async function checkOnline(t){try{const n=await fetch("https://decapi.me/twitch/uptime/"+encodeURIComponent(t));if(!n.ok)return!1;const l=await n.text();return!/offline/i.test(l)}catch{return!1}}async function findAndPlayMultiple(t,n){if(!settings.shuffle){const o=[];let c=t;for(let u=0;u<users.length&&o.length<n;u++){const h=users[c%users.length];try{await checkOnline(h)&&o.push(h)}catch{}c++}return o.length===0?!1:(mountPlayers(o),displayedUsers=o.slice(),currentIndex=(c-1)%users.length,!0)}const l=[];for(const o of users)try{await checkOnline(o)&&l.push(o)}catch{}if(l.length===0)return!1;const e=Math.min(n,l.length),s=new Set(displayedUsers||[]),i=l.filter(o=>!s.has(o)),a=[];function r(o,c){const u=[],h=o.slice();for(;u.length<c&&h.length;){const m=Math.floor(Math.random()*h.length);u.push(h.splice(m,1)[0])}return u}if(i.length>=e)a.push(...r(i,e));else{a.push(...i);const o=e-a.length,c=l.filter(u=>!a.includes(u));c.length<=o?a.push(...c.slice(0,o)):a.push(...r(c,o))}mountPlayers(a),displayedUsers=a.slice();const d=a[a.length-1],f=users.indexOf(d);return currentIndex=f>=0?f:t,!0}function getPlayersCount(){const t=settings&&settings.layout||DEFAULT_SETTINGS.layout;return t==="2x2"?4:t==="4x3"?12:1}async function rotate(){const t=getPlayersCount(),n=(currentIndex+1)%users.length;await findAndPlayMultiple(n,t),remainingMs=null,nextRotateAt=null}function scheduleTimeout(t){rotateTimer=setTimeout(async()=>{await rotate(),settings.autoRotate&&!runtimePaused&&(nextRotateAt=Date.now()+Math.max(5,Number(settings.durationSec)||DEFAULT_SETTINGS.durationSec)*1e3,scheduleTimeout(Math.max(5,Number(settings.durationSec)||DEFAULT_SETTINGS.durationSec)*1e3))},t),nextRotateAt=Date.now()+t}function startRotation(){if(stopRotation(),!settings.autoRotate||runtimePaused)return;const t=Math.max(5,Number(settings.durationSec)||DEFAULT_SETTINGS.durationSec)*1e3;remainingMs!=null?(scheduleTimeout(remainingMs),remainingMs=null):scheduleTimeout(t)}function stopRotation(){rotateTimer&&(clearTimeout(rotateTimer),rotateTimer=null),nextRotateAt?remainingMs=Math.max(0,nextRotateAt-Date.now()):remainingMs=null,nextRotateAt=null}const playPauseBtn=document.getElementById("playPauseBtn"),settingsBtn=document.getElementById("settingsBtn"),countdownEl=document.getElementById("countdown"),playSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><path d="M5 3v18l15-9L5 3z"/></svg>',pauseSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',gearSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8.94 2.06l-1.43-.37a7.026 7.026 0 00-.5-1.21l.91-1.23a1 1 0 00-.12-1.31l-1.41-1.41a1 1 0 00-1.31-.12l-1.23.91c-.39-.21-.79-.38-1.21-.5l-.37-1.43A1 1 0 0012 2h-2a1 1 0 00-.98.84l-.37 1.43c-.42.12-.82.29-1.21.5l-1.23-.91a1 1 0 00-1.31.12L2.7 6.64a1 1 0 00-.12 1.31l.91 1.23c-.21.39-.38.79-.5 1.21L1.6 10.7A1 1 0 001 12v2a1 1 0 00.84.98l1.43.37c.12.42.29.82.5 1.21l-.91 1.23a1 1 0 00.12 1.31l1.41 1.41a1 1 0 001.31.12l1.23-.91c.39.21.79.38 1.21.5l.37 1.43A1 1 0 0010 22h2a1 1 0 00.98-.84l.37-1.43c.42-.12.82-.29 1.21-.5l1.23.91a1 1 0 001.31-.12l1.41-1.41a1 1 0 00.12-1.31l-.91-1.23c.21-.39.38-.79.5-1.21l1.43-.37A1 1 0 0022 14v-2a1 1 0 00-.06-.34z"/></svg>';function updatePlayPauseUi(){playPauseBtn&&(runtimePaused?(playPauseBtn.innerHTML=playSvg,playPauseBtn.title="Resume rotation",playPauseBtn.setAttribute("aria-pressed","true")):(playPauseBtn.innerHTML=pauseSvg,playPauseBtn.title="Pause rotation",playPauseBtn.setAttribute("aria-pressed","false")),settingsBtn&&(settingsBtn.innerHTML=gearSvg))}playPauseBtn&&playPauseBtn.addEventListener("click",()=>{settings.autoRotate=!settings.autoRotate,runtimePaused=!settings.autoRotate,saveSettings(),runtimePaused?stopRotation():startRotation(),updatePlayPauseUi()});function updateCountdown(){if(!countdownEl)return;if(!settings.autoRotate){countdownEl.textContent="Auto-rotate paused";return}if(runtimePaused){remainingMs!=null?countdownEl.textContent=`Paused: ${Math.ceil(remainingMs/1e3)}s`:countdownEl.textContent="Paused";return}if(!nextRotateAt){countdownEl.textContent="Waiting";return}const t=Math.max(0,Math.ceil((nextRotateAt-Date.now())/1e3));countdownEl.textContent=`Next: ${t}s`}(async function(){await findAndPlayMultiple(0,getPlayersCount()),updatePlayPauseUi(),countdownInterval&&clearInterval(countdownInterval),countdownInterval=setInterval(updateCountdown,250),startRotation()})();const dialogBackdrop=document.getElementById("dialogBackdrop"),autoRotateInput=document.getElementById("autoRotate"),durationInput=document.getElementById("autoRotateDuration"),saveBtn=document.getElementById("saveBtn"),cancelBtn=document.getElementById("cancelBtn");function openDialog(){autoRotateInput.checked=!!settings.autoRotate,durationInput.value=String(settings.durationSec||DEFAULT_SETTINGS.durationSec);const t=document.getElementById("layoutSelect");t&&(t.value=settings.layout||DEFAULT_SETTINGS.layout),renderChannelsList(),setupChannelsAdd(),dialogBackdrop.style.display="flex",dialogBackdrop.setAttribute("aria-hidden","false"),durationInput.focus()}function closeDialog(){dialogBackdrop.style.display="none",dialogBackdrop.setAttribute("aria-hidden","true"),settingsBtn.focus()}document.getElementById("autoRotate").checked=settings.autoRotate,document.getElementById("autoRotateDuration").value=settings.durationSec,document.getElementById("layoutSelect").value=settings.layout,document.getElementById("shuffleToggle").checked=!!settings.shuffle,window.addEventListener("keydown",t=>{t.key==="Escape"&&dialogBackdrop.style.display==="flex"&&closeDialog()}),saveBtn.addEventListener("click",()=>{const t=!!document.getElementById("autoRotate").checked,n=clamp(Number(document.getElementById("autoRotateDuration").value)||DEFAULT_SETTINGS.durationSec,5,3600),l=document.getElementById("layoutSelect").value||DEFAULT_SETTINGS.layout,e=!!document.getElementById("shuffleToggle").checked;settings.autoRotate=t,settings.durationSec=n,settings.layout=l,settings.shuffle=e,runtimePaused=!settings.autoRotate;const s=settings.durationSec*1e3;if(nextRotateAt!=null){const i=Math.max(0,nextRotateAt-Date.now());remainingMs=Math.min(i,s),rotateTimer&&(clearTimeout(rotateTimer),rotateTimer=null),nextRotateAt=remainingMs!=null?Date.now()+remainingMs:null}else remainingMs!=null&&(remainingMs=Math.min(remainingMs,s));saveSettings(),applyLayout(),runtimePaused?stopRotation():startRotation(),updatePlayPauseUi(),closeDialog()});const layoutSelectEl=document.getElementById("layoutSelect");layoutSelectEl&&layoutSelectEl.addEventListener("change",async t=>{settings.layout=t.target.value,await applyLayout(),startRotation()}),settingsBtn&&settingsBtn.addEventListener("click",()=>openDialog()),cancelBtn&&cancelBtn.addEventListener("click",()=>closeDialog()),window.TwitchCycle={settings,saveSettings,startRotation,stopRotation,rotateOnce:rotate};async function applyLayout(){const t=getPlayersCount();await findAndPlayMultiple((currentIndex+1)%users.length,t)}</script></body>