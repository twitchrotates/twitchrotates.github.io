<title>TwitchCycle</title><style>:root{--bg:#071124;--muted:#9ca3af;--accent:#7dd3fc}html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}body{display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(180deg,var(--bg),#071122);color:#e6eef8}a:focus{outline:none}.app{display:flex;flex-direction:column;height:100vh}main{flex:1;display:block;padding:0;margin:0;height:100%;position:relative}.sidebar{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.35));display:flex;flex-direction:row;align-items:center;justify-content:center;gap:24px;padding:8px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.4);z-index:1500;opacity:0;transition:opacity 0.3s ease}.sidebar:hover{opacity:1}.side-btn{width:40px;height:40px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.35);color:var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}.side-btn svg{width:20px;height:20px;display:block}.side-btn:focus{outline:2px solid rgba(125,211,252,0.25)}.countdown{font-size:12px;color:var(--muted);width:140px;text-align:center}.player-wrap{position:relative;width:100%;height:100vh;max-width:none}#playerContainer{background:rgba(255,255,255,0.01);border-radius:0;overflow:hidden;height:100%}.dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:4000}.dialog{background:#071226;border-radius:8px;padding:16px;min-width:360px;max-width:760px;color:inherit;border:1px solid rgba(255,255,255,0.03)}.dialog h3{margin:0 0 8px 0}.field{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;margin:10px 0}.field label{margin:0;color:var(--muted)}.field input[type="text"]{width:120px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;text-align:left}.field input[type="checkbox"]{width:18px;height:18px}.dialog .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}.channels-section{margin-top:12px;border-top:1px solid rgba(255,255,255,0.02);padding-top:12px}.channels-list{list-style:none;margin:0;padding:0;max-height:240px;overflow:auto;border-radius:6px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01)}.channels-list li{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:grab}.channels-list li.dragging{opacity:0.5}.channels-list li .name{flex:1;color:inherit}.channels-list li .actions{display:flex;gap:8px;margin-left:8px}.channels-list li button{background:transparent;border:0;color:var(--muted);cursor:pointer}.channels-add{display:flex;gap:8px;margin-top:8px}.channels-add input{flex:1;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}.btn{padding:8px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;cursor:pointer}.btn.primary{background:var(--accent);color:#042029;border:none}iframe{display:block;border:0;width:100%;height:100%}</style></head><body><div class="app"><aside class="sidebar" id="controlsBar" aria-label="Controls"><button id="playPauseBtn" class="side-btn" aria-pressed="false" title="Pause rotation" aria-label="Play pause"></button><button id="settingsBtn" class="side-btn" aria-label="Settings"></button><div id="countdown" class="countdown" aria-live="polite"></div></aside><main><div class="player-wrap" id="playerWrap"><div id="playerContainer"><div style="padding:18px;color:var(--muted);font-size:13px">Loading player...</div></div></div></main></div><div id="dialogBackdrop" class="dialog-backdrop" aria-hidden="true"><div class="dialog" role="dialog" aria-modal="true"><h3>Settings</h3><div class="field"><label for="autoRotate">Auto rotate</label><input id="autoRotate" type="checkbox" /></div><div class="field"><label for="autoRotateDuration">Auto rotate duration (seconds)</label><input id="autoRotateDuration" type="number" inputmode="numeric" pattern="[0-9]*" /></div><div class="field"><label for="layoutSelect">Layout</label><select id="layoutSelect"><option value="fullscreen">Fullscreen</option><option value="2x2">2x2</option><option value="4x3">4x3</option></select></div><div class="field"><label for="shuffleToggle" title="When checked, select streams randomly and prefer ones not currently shown">Shuffle</label><input type="checkbox" id="shuffleToggle" /></div><div class="channels-section"><h4 style="margin:0 0 8px 0;color:var(--muted)">Channels</h4><ul id="channelsList" class="channels-list" role="list"></ul><div class="channels-add"><input id="addChannelInput" placeholder="Add channel (name)" aria-label="Add channel" /><button id="addChannelBtn" class="btn">Add</button></div></div><div class="actions"><button id="cancelBtn" class="btn">Cancel</button><button id="saveBtn" class="btn primary">Save</button></div></div></div><script>const du=['AdamRoguezy','ADarkLegacy','aksually','ARCHIT3CT','ashleyroboto','banthony','blizz','BobbyBurm','butteryflaky','bwick','Carla','cheebs','chiblee','chrismelberger','ChrispyGameplay','Crub','detune','dudlik','EthanNestor','hankstergirl','hanner','JessCapricorn','johnchoi','LeoSypniewski','Loganolio','Michael_Lopriore','nandre','PapaHogsPalaceOfPleasure','PointCrow','prezoh','sandy','Shaggedy','Skootish','vaqrgaming','vixella','whisqey'].map(s=>s.trim()).filter(Boolean);let u=loadUsers();function loadUsers(){try{const raw=localStorage.getItem('tc.u.v1');if(!raw)return du.slice();const parsed=JSON.parse(raw);if(Array.isArray(parsed)&&parsed.length)return parsed.map(s=>String(s).trim()).filter(Boolean);return du.slice();}catch(e){return du.slice();}}function saveUsers(){try{localStorage.setItem('tc.u.v1',JSON.stringify(u));}catch(e){}}const p=document.getElementById('p');let i=0;let t=null;let n=null;let r=null;let pa=false;let c=null;let d=[];const sk='tc.s.v1';const ds={autoRotate:true,durationSec:60,layout:'fullscreen',shuffle:true};let s=loadSettings();pa=!s.autoRotate;function loadSettings(){try{const s=JSON.parse(localStorage.getItem(sk));return Object.assign({},ds,s||{});}catch(e){return Object.assign({},ds);}}function saveSettings(){localStorage.setItem(sk,JSON.stringify(s));}function clamp(v,a,b){return Math.max(a,Math.min(b,v));}function parentForEmbed(){return location.hostname||'localhost';}const trashSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false" style="width:16px;height:16px;display:inline-block"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-9l-1 1H5v2h14V4z"/></svg>';function renderChannelsList(){const list=document.getElementById('channelsList');if(!list)return;list.innerHTML='';u.forEach((u,idx)=>{const li=document.createElement('li');li.setAttribute('draggable','true');li.dataset.index=String(idx);const name=document.createElement('div');name.className='name';name.textContent=u;const actions=document.createElement('div');actions.className='actions';const del=document.createElement('button');del.type='button';del.title='Delete channel';del.innerHTML=trashSvg;del.addEventListener('click',(e)=>{e.stopPropagation();if(!confirm(`Delete channel "${u}"?`))return;u.splice(idx,1);saveUsers();renderChannelsList();});actions.appendChild(del);li.appendChild(name);li.appendChild(actions);li.addEventListener('dragstart',(ev)=>{li.classList.add('dragging');ev.dataTransfer.setData('text/plain',String(idx));ev.dataTransfer.effectAllowed='move';});li.addEventListener('dragend',()=>{li.classList.remove('dragging');});li.addEventListener('dragover',(ev)=>{ev.preventDefault();ev.dataTransfer.dropEffect='move';const target=ev.currentTarget;});li.addEventListener('drop',(ev)=>{ev.preventDefault();const from=Number(ev.dataTransfer.getData('text/plain'));const to=Number(li.dataset.index);if(Number.isNaN(from)||Number.isNaN(to)||from===to)return;const item=u.splice(from,1)[0];u.splice(to,0,item);saveUsers();renderChannelsList();});list.appendChild(li);});}function setupChannelsAdd(){const input=document.getElementById('addChannelInput');const btn=document.getElementById('addChannelBtn');if(!input||!btn)return;btn.addEventListener('click',()=>{const v=String(input.value||'').trim();if(!v)return;const name=v.replace(/^@/,'');u.push(name);saveUsers();renderChannelsList();input.value='';});input.addEventListener('keydown',(e)=>{if(e.key==='Enter')btn.click();});}function mountPlayers(usersList){p.innerHTML='';p.style.display='';p.style.gridTemplateColumns='';p.style.gridAutoRows='';p.style.gap='';const count=usersList.length;if(count<=1){const iframe=document.createElement('iframe');iframe.id='twitch-player-0';iframe.allow='autoplay; fullscreen';iframe.src=`https://player.twitch.tv/?channel=${encodeURIComponent(usersList[0])}&parent=${encodeURIComponent(parentForEmbed())}&muted=true&autoplay=true`;p.style.display='';p.appendChild(iframe);return;}let cols=2;let rows=Math.ceil(count/cols);if(count===12){cols=4;rows=3;}p.style.display='grid';p.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;p.style.gridAutoRows='1fr';p.style.gap='4px';for(let i=0;i<usersList.length;i++){const u=usersList[i];const wrap=document.createElement('div');wrap.style.position='relative';wrap.style.width='100%';wrap.style.paddingTop='56.25%';wrap.style.overflow='hidden';const iframe=document.createElement('iframe');iframe.id=`twitch-player-${i}`;iframe.allow='autoplay; fullscreen';iframe.src=`https://player.twitch.tv/?channel=${encodeURIComponent(u)}&parent=${encodeURIComponent(parentForEmbed())}&muted=true&autoplay=true`;iframe.style.width='100%';iframe.style.height='100%';iframe.style.display='block';iframe.style.position='absolute';iframe.style.left='0';iframe.style.top='0';iframe.style.border='0';wrap.appendChild(iframe);p.appendChild(wrap);}}async function checkOnline(user){try{const res=await fetch('https://decapi.me/twitch/uptime/'+encodeURIComponent(user));if(!res.ok)return false;const txt=await res.text();return!/offline/i.test(txt);}catch(e){return false;}}async function findAndPlayMultiple(startIndex,count){if(!s.shuffle){const found=[];let idx=startIndex;for(let i=0;i<u.length&&found.length<count;i++){const user=u[idx%u.length];try{const online=await checkOnline(user);if(online){found.push(user);}}catch(e){}idx++;}if(found.length===0)return false;mountPlayers(found);d=found.slice();i=(idx-1)%u.length;return true;}const online=[];for(const u of u){try{if(await checkOnline(u))online.push(u);}catch(e){}}if(online.length===0)return false;const want=Math.min(count,online.length);const currentlyShown=new Set(d||[]);const candidates=online.filter(u=>!currentlyShown.has(u));const pick=[];function pickRandomFrom(arr,n){const out=[];const copy=arr.slice();while(out.length<n&&copy.length){const i=Math.floor(Math.random()*copy.length);out.push(copy.splice(i,1)[0]);}return out;}if(candidates.length>=want){pick.push(...pickRandomFrom(candidates,want));}else{pick.push(...candidates);const remaining=want-pick.length;const remainingPool=online.filter(u=>!pick.includes(u));if(remainingPool.length<=remaining){pick.push(...remainingPool.slice(0,remaining));}else{pick.push(...pickRandomFrom(remainingPool,remaining));}}mountPlayers(pick);d=pick.slice();const last=pick[pick.length-1];const li=u.indexOf(last);i=li>=0?li:startIndex;return true;}function getPlayersCount(){const layout=(s&&s.layout)||ds.layout;if(layout==='2x2')return 4;if(layout==='4x3')return 12;return 1;}async function rotate(){const count=getPlayersCount();const nextIndex=(i+1)%u.length;await findAndPlayMultiple(nextIndex,count);r=null;n=null;}function scheduleTimeout(ms){t=setTimeout(async()=>{await rotate();if(s.autoRotate&&!pa){n=Date.now()+Math.max(5,Number(s.durationSec)||ds.durationSec)*1000;scheduleTimeout(Math.max(5,Number(s.durationSec)||ds.durationSec)*1000);}},ms);n=Date.now()+ms;}function startRotation(){stopRotation();if(!s.autoRotate||pa)return;const durMs=Math.max(5,Number(s.durationSec)||ds.durationSec)*1000;if(r!=null){scheduleTimeout(r);r=null;}else{scheduleTimeout(durMs);}}function stopRotation(){if(t){clearTimeout(t);t=null;}if(n){r=Math.max(0,n-Date.now());}else{r=null;}n=null;}const pb=document.getElementById('pb');const sb=document.getElementById('sb');const ce=document.getElementById('countdown');const playSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><path d="M5 3v18l15-9L5 3z"/></svg>';const pauseSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';const gearSvg='<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8.94 2.06l-1.43-.37a7.026 7.026 0 00-.5-1.21l.91-1.23a1 1 0 00-.12-1.31l-1.41-1.41a1 1 0 00-1.31-.12l-1.23.91c-.39-.21-.79-.38-1.21-.5l-.37-1.43A1 1 0 0012 2h-2a1 1 0 00-.98.84l-.37 1.43c-.42.12-.82.29-1.21.5l-1.23-.91a1 1 0 00-1.31.12L2.7 6.64a1 1 0 00-.12 1.31l.91 1.23c-.21.39-.38.79-.5 1.21L1.6 10.7A1 1 0 001 12v2a1 1 0 00.84.98l1.43.37c.12.42.29.82.5 1.21l-.91 1.23a1 1 0 00.12 1.31l1.41 1.41a1 1 0 001.31.12l1.23-.91c.39.21.79.38 1.21.5l.37 1.43A1 1 0 0010 22h2a1 1 0 00.98-.84l.37-1.43c.42-.12.82-.29 1.21-.5l1.23.91a1 1 0 001.31-.12l1.41-1.41a1 1 0 00.12-1.31l-.91-1.23c.21-.39.38-.79.5-1.21l1.43-.37A1 1 0 0022 14v-2a1 1 0 00-.06-.34z"/></svg>';function updatePlayPauseUi(){if(!pb)return;if(pa){pb.innerHTML=playSvg;pb.title='Resume rotation';pb.setAttribute('aria-pressed','true');}else{pb.innerHTML=pauseSvg;pb.title='Pause rotation';pb.setAttribute('aria-pressed','false');}if(sb)sb.innerHTML=gearSvg;}if(pb){pb.addEventListener('click',()=>{s.autoRotate=!s.autoRotate;pa=!s.autoRotate;saveSettings();if(pa){stopRotation();}else{startRotation();}updatePlayPauseUi();});}function updateCountdown(){if(!ce)return;if(!s.autoRotate){ce.textContent='Auto-rotate paused';return;}if(pa){if(r!=null){ce.textContent=`Paused: ${Math.ceil(r/1000)}s`;}else{ce.textContent='Paused';}return;}if(!n){ce.textContent='Waiting';return;}const sec=Math.max(0,Math.ceil((n-Date.now())/1000));ce.textContent=`Next: ${sec}s`;}(async function init(){await findAndPlayMultiple(0,getPlayersCount());updatePlayPauseUi();if(c)clearInterval(c);c=setInterval(updateCountdown,250);startRotation();})();const db=document.getElementById('db');const autoRotateInput=document.getElementById('autoRotate');const durationInput=document.getElementById('autoRotateDuration');const sv=document.getElementById('sv');const ca=document.getElementById('ca');function openDialog(){autoRotateInput.checked=!!s.autoRotate;durationInput.value=String(s.durationSec||ds.durationSec);const layoutSelect=document.getElementById('layoutSelect');if(layoutSelect)layoutSelect.value=s.layout||ds.layout;renderChannelsList();setupChannelsAdd();db.style.display='flex';db.setAttribute('aria-hidden','false');durationInput.focus();}function closeDialog(){db.style.display='none';db.setAttribute('aria-hidden','true');sb.focus();}document.getElementById('autoRotate').checked=s.autoRotate;document.getElementById('autoRotateDuration').value=s.durationSec;document.getElementById('layoutSelect').value=s.layout;document.getElementById('shuffleToggle').checked=!!s.shuffle;window.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&db.style.display==='flex')closeDialog();});sv.addEventListener('click',()=>{const ar=!!document.getElementById('autoRotate').checked;const dur=clamp(Number(document.getElementById('autoRotateDuration').value)||ds.durationSec,5,3600);const layoutVal=document.getElementById('layoutSelect').value||ds.layout;const shuffleVal=!!document.getElementById('shuffleToggle').checked;s.autoRotate=ar;s.durationSec=dur;s.layout=layoutVal;s.shuffle=shuffleVal;pa=!s.autoRotate;const newDurMs=s.durationSec*1000;if(n!=null){const timeLeft=Math.max(0,n-Date.now());r=Math.min(timeLeft,newDurMs);if(t){clearTimeout(t);t=null;}n=r!=null?Date.now()+r:null;}else if(r!=null){r=Math.min(r,newDurMs);}saveSettings();applyLayout();if(pa){stopRotation();}else{startRotation();}updatePlayPauseUi();closeDialog();});}window.TwitchCycle={s,saveSettings,startRotation,stopRotation,rotateOnce:rotate};async function applyLayout(){const count=getPlayersCount();await findAndPlayMultiple((i+1)%u.length,count);}</script></body></html>